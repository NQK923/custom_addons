<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Invoice Form Template -->
    <template id="invoice_form_template" name="Create/Edit Invoice">
        <t t-call="invoice_management.invoice_management_layout">
            <t t-set="page_title">
                <t t-if="edit_mode">Chỉnh sửa hóa đơn</t>
                <t t-else="">Tạo hóa đơn mới</t>
            </t>

            <!-- Actions -->
            <div class="im-actions">
                <a href="/invoice/list" class="btn btn-secondary">
                    <i class="fa fa-arrow-left"></i>
                    Quay lại
                </a>
            </div>

            <!-- Invoice Form -->
            <div class="im-card">
                <h3>
                    <t t-if="edit_mode">Chỉnh sửa hóa đơn</t>
                    <t t-else="">Tạo hóa đơn mới</t>
                </h3>

                <!-- Error message display -->
                <div t-if="error_message" class="alert alert-danger" role="alert">
                    <t t-esc="error_message"/>
                </div>

                <form method="POST" t-attf-action="/invoice/#{edit_mode and 'edit/' + str(invoice.id) or 'create'}"
                      id="invoice-form">
                    <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>

                    <div class="form-group row">
                        <label for="patient_id" class="col-sm-3 col-form-label">Bệnh nhân</label>
                        <div class="col-sm-9">
                            <select name="patient_id" id="patient_id" class="form-control" required="required">
                                <option value="">-- Chọn bệnh nhân --</option>
                                <t t-foreach="patients" t-as="patient">
                                    <option t-att-value="patient.id"
                                            t-att-selected="invoice and invoice.patient_id.id == patient.id">
                                        <t t-esc="patient.name"/>
                                        (<t t-esc="patient.code"/>)
                                    </option>
                                </t>
                            </select>
                        </div>
                    </div>

                    <!-- Thêm trường chọn đơn thuốc -->
                    <div class="form-group row" id="prescription-container" style="display: none;">
                        <label for="prescription_id" class="col-sm-3 col-form-label">Đơn thuốc</label>
                        <div class="col-sm-9">
                            <select name="prescription_id" id="prescription_id" class="form-control">
                                <option value="">-- Chọn đơn thuốc --</option>
                                <!-- Options will be loaded dynamically -->
                            </select>
                        </div>
                    </div>

                    <div class="form-group row">
                        <label for="invoice_date" class="col-sm-3 col-form-label">Ngày lập</label>
                        <div class="col-sm-9">
                            <input type="date" class="form-control" id="invoice_date" name="invoice_date"
                                   t-att-value="invoice and invoice.invoice_date or today"
                                   required="required"/>
                        </div>
                    </div>

                    <!-- Service Lines -->
                    <h4 class="mt-4 mb-3">Dịch vụ</h4>
                    <div class="service-lines-container">
                        <div class="form-row align-items-center mb-2 service-line-template">
                            <div class="col-5">
                                <select name="service_id[]" class="form-control service-select"
                                        onchange="updateServicePrice(this)">
                                    <option value="">-- Chọn dịch vụ --</option>
                                    <t t-foreach="services" t-as="service">
                                        <option t-att-value="service.id" t-att-data-price="service.price">
                                            <t t-esc="service.service_name"/>
                                        </option>
                                    </t>
                                </select>
                            </div>
                            <div class="col-2">
                                <input type="number" name="service_qty[]" class="form-control" placeholder="Số lượng"
                                       min="1" step="1" value="1"/>
                            </div>
                            <div class="col-3">
                                <span class="form-control-plaintext service-price-display">0 VND</span>
                                <input type="hidden" name="service_price_unit[]" class="service-price" value="0"/>
                            </div>
                            <div class="col-2">
                                <button type="button" class="btn btn-danger remove-line">
                                    <i class="fa fa-trash"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Service lines will be added here -->
                        <div id="service-lines">
                            <!-- Display existing service lines for edit mode -->
                            <t t-if="invoice and invoice.service_lines">
                                <t t-foreach="invoice.service_lines" t-as="line">
                                    <div class="form-row align-items-center mb-2 service-line">
                                        <div class="col-5">
                                            <select name="service_id[]" class="form-control service-select"
                                                    onchange="updateServicePrice(this)">
                                                <option value="">-- Chọn dịch vụ --</option>
                                                <t t-foreach="services" t-as="service">
                                                    <option t-att-value="service.id" t-att-data-price="service.price"
                                                            t-att-selected="line.service_id.id == service.id">
                                                        <t t-esc="service.service_name"/>
                                                    </option>
                                                </t>
                                            </select>
                                        </div>
                                        <div class="col-2">
                                            <input type="number" name="service_qty[]" class="form-control"
                                                   placeholder="Số lượng"
                                                   min="1" step="1" t-att-value="line.quantity"/>
                                        </div>
                                        <div class="col-3">
                                            <span class="form-control-plaintext service-price-display">
                                                <t t-esc="'{:,.0f}'.format(line.price_unit)"/>
                                                VND
                                            </span>
                                            <input type="hidden" name="service_price[]" class="service-price"
                                                   t-att-value="line.price_unit"/>
                                        </div>
                                        <div class="col-2">
                                            <button type="button" class="btn btn-danger remove-line">
                                                <i class="fa fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                </t>
                            </t>
                        </div>

                        <div class="text-right mb-3">
                            <button type="button" class="btn btn-sm btn-info add-service-line">
                                <i class="fa fa-plus"></i>
                                Thêm dịch vụ
                            </button>
                        </div>
                    </div>

                    <!-- Product Lines -->
                    <h4 class="mt-4 mb-3">Thuốc</h4>
                    <div class="product-lines-container">
                        <div class="form-row align-items-center mb-2 product-line-template">
                            <div class="col-5">
                                <select name="product_id[]" class="form-control product-select"
                                        onchange="updateProductPrice(this)">
                                    <option value="">-- Chọn thuốc --</option>
                                    <t t-foreach="products" t-as="product">
                                        <option t-att-value="product.id" t-att-data-price="product.unit_price">
                                            <t t-esc="product.name"/>
                                            (SL:<t t-esc="product.quantity"/>)
                                        </option>
                                    </t>
                                </select>
                            </div>
                            <div class="col-2">
                                <input type="number" name="product_qty[]" class="form-control" placeholder="Số lượng"
                                       min="1" step="1" value="1"/>
                            </div>
                            <div class="col-3">
                                <span class="form-control-plaintext product-price-display">0 VND</span>
                                <input type="hidden" name="product_price_unit[]" class="product-price" value="0"/>
                            </div>
                            <div class="col-2">
                                <button type="button" class="btn btn-danger remove-line">
                                    <i class="fa fa-trash"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Product lines will be added here -->
                        <div id="product-lines">
                            <!-- Display existing product lines for edit mode -->
                            <t t-if="invoice and invoice.product_lines">
                                <t t-foreach="invoice.product_lines" t-as="line">
                                    <div class="form-row align-items-center mb-2 product-line">
                                        <div class="col-5">
                                            <select name="product_id[]" class="form-control product-select"
                                                    onchange="updateProductPrice(this)">
                                                <option value="">-- Chọn thuốc --</option>
                                                <t t-foreach="products" t-as="product">
                                                    <option t-att-value="product.id"
                                                            t-att-data-price="product.unit_price"
                                                            t-att-selected="line.product_id.id == product.id">
                                                        <t t-esc="product.name"/>
                                                        (SL:<t t-esc="product.quantity"/>)
                                                    </option>
                                                </t>
                                            </select>
                                        </div>
                                        <div class="col-2">
                                            <input type="number" name="product_qty[]" class="form-control"
                                                   placeholder="Số lượng"
                                                   min="1" step="1" t-att-value="line.quantity"/>
                                        </div>
                                        <div class="col-3">
                                            <span class="form-control-plaintext product-price-display">
                                                <t t-esc="'{:,.0f}'.format(line.price_unit)"/>
                                                VND
                                            </span>
                                            <input type="hidden" name="product_price[]" class="product-price"
                                                   t-att-value="line.price_unit"/>
                                        </div>
                                        <div class="col-2">
                                            <button type="button" class="btn btn-danger remove-line">
                                                <i class="fa fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                </t>
                            </t>
                        </div>

                        <div class="text-right mb-3">
                            <button type="button" class="btn btn-sm btn-info add-product-line">
                                <i class="fa fa-plus"></i>
                                Thêm thuốc
                            </button>
                        </div>
                    </div>

                    <div class="form-group row">
                        <label for="note" class="col-sm-3 col-form-label">Ghi chú</label>
                        <div class="col-sm-9">
                            <textarea class="form-control" id="note" name="note" rows="3">
                                <t t-esc="invoice and invoice.note or ''"/>
                            </textarea>
                        </div>
                    </div>

                    <div class="form-group row">
                        <div class="col-sm-9 offset-sm-3">
                            <button type="button" id="submit-invoice-btn" class="btn btn-primary">
                                <t t-if="edit_mode">Cập nhật</t>
                                <t t-else="">Tạo hóa đơn</t>
                            </button>
                            <a href="/invoice/list" class="btn btn-secondary ml-2">Hủy</a>
                        </div>
                    </div>
                </form>

                <script type="text/javascript">
                    // Global functions to update prices
                    function updateServicePrice(selectElement) {
                    try {
                    var selectedOption = selectElement.options[selectElement.selectedIndex];
                    var price = selectedOption.getAttribute('data-price') || 0;
                    var row = selectElement.closest('.form-row');
                    var priceDisplay = row.querySelector('.service-price-display');
                    var priceField = row.querySelector('.service-price');

                    if (priceField) {
                    priceField.value = price;
                    if (priceDisplay) {
                    priceDisplay.textContent = new Intl.NumberFormat('vi-VN').format(price) + ' VND';
                    }
                    }
                    } catch (error) {
                    console.error('Error updating service price:', error);
                    }
                    }

                    function updateProductPrice(selectElement) {
                    try {
                    var selectedOption = selectElement.options[selectElement.selectedIndex];
                    var price = selectedOption.getAttribute('data-price') || 0;
                    var row = selectElement.closest('.form-row');
                    var priceDisplay = row.querySelector('.product-price-display');
                    var priceField = row.querySelector('.product-price');

                    if (priceField) {
                    priceField.value = price;
                    if (priceDisplay) {
                    priceDisplay.textContent = new Intl.NumberFormat('vi-VN').format(price) + ' VND';
                    }
                    }
                    } catch (error) {
                    console.error('Error updating product price:', error);
                    }
                    }

                    document.addEventListener('DOMContentLoaded', function() {
                    console.log('DOM loaded - initializing invoice form');

                    // Add service line function
                    function addServiceLine() {
                    var template = document.querySelector('.service-line-template').cloneNode(true);
                    template.classList.remove('service-line-template');
                    template.classList.add('service-line');
                    template.style.display = 'flex';

                    // Add event listener to remove button
                    template.querySelector('.remove-line').addEventListener('click', function() {
                    var lines = document.querySelectorAll('.service-line');
                    if (lines.length > 0) {
                    this.closest('.service-line').remove();
                    }
                    });

                    // Set up service selection event handler
                    var select = template.querySelector('.service-select');
                    if (select) {
                    select.addEventListener('change', function() {
                    updateServicePrice(this);
                    });
                    }

                    // Add to service lines container
                    document.getElementById('service-lines').appendChild(template);
                    }

                    // Add product line function
                    function addProductLine(productId, quantity, price) {
                    var template = document.querySelector('.product-line-template').cloneNode(true);
                    template.classList.remove('product-line-template');
                    template.classList.add('product-line');
                    template.style.display = 'flex';

                    // Set product ID if provided
                    if (productId) {
                    var productSelect = template.querySelector('.product-select');
                    if (productSelect) {
                    productSelect.value = productId;
                    updateProductPrice(productSelect);
                    }
                    }

                    // Set quantity if provided
                    if (quantity) {
                    var quantityInput = template.querySelector('input[name="product_qty[]"]');
                    if (quantityInput) {
                    quantityInput.value = quantity;
                    }
                    }

                    // Add event listener to remove button
                    template.querySelector('.remove-line').addEventListener('click', function() {
                    var lines = document.querySelectorAll('.product-line');
                    if (lines.length > 0) {
                    this.closest('.product-line').remove();
                    }
                    });

                    // Set up product selection event handler
                    var select = template.querySelector('.product-select');
                    if (select) {
                    select.addEventListener('change', function() {
                    updateProductPrice(this);
                    });
                    }

                    // Add to product lines container
                    document.getElementById('product-lines').appendChild(template);

                    return template;
                    }

                    // Add event listeners to add buttons
                    var addServiceButton = document.querySelector('.add-service-line');
                    if (addServiceButton) {
                    addServiceButton.addEventListener('click', addServiceLine);
                    console.log('Add service line button event handler attached');
                    }

                    var addProductButton = document.querySelector('.add-product-line');
                    if (addProductButton) {
                    addProductButton.addEventListener('click', function() {
                    addProductLine();
                    });
                    console.log('Add product line button event handler attached');
                    }

                    // Add event listeners to existing remove buttons and setup price displays
                    document.querySelectorAll('.service-line .remove-line').forEach(function(button) {
                    button.addEventListener('click', function() {
                    var lines = document.querySelectorAll('.service-line');
                    if (lines.length > 0) {
                    this.closest('.service-line').remove();
                    }
                    });
                    });

                    document.querySelectorAll('.product-line .remove-line').forEach(function(button) {
                    button.addEventListener('click', function() {
                    var lines = document.querySelectorAll('.product-line');
                    if (lines.length > 0) {
                    this.closest('.product-line').remove();
                    }
                    });
                    });

                    // Initialize price displays for existing lines
                    document.querySelectorAll('.service-line .service-select').forEach(function(select) {
                    updateServicePrice(select);
                    });

                    document.querySelectorAll('.product-line .product-select').forEach(function(select) {
                    updateProductPrice(select);
                    });

                    // Hide template lines
                    document.querySelector('.service-line-template').style.display = 'none';
                    document.querySelector('.product-line-template').style.display = 'none';

                    // Add patient selection handler
                    var patientSelect = document.getElementById('patient_id');
                    var prescriptionContainer = document.getElementById('prescription-container');
                    var prescriptionSelect = document.getElementById('prescription_id');

                    if (patientSelect &amp;&amp; prescriptionContainer &amp;&amp; prescriptionSelect) {
                    console.log('Found all prescription-related elements in the DOM');

                    patientSelect.addEventListener('change', function() {
                    var patientId = this.value;
                    console.log('Patient selection changed. Selected patient ID:', patientId);

                    // Clear current prescription options
                    prescriptionSelect.innerHTML = '<option value="">-- Chọn đơn thuốc --</option>';

                    if (patientId) {
                    console.log('Showing prescription container');
                    // Show prescription selection
                    prescriptionContainer.style.display = 'flex';

                    // Fetch prescriptions for selected patient
                    console.log('Fetching prescriptions from API for patient ID:', patientId);
                    fetch('/api/prescriptions?patient_id=' + patientId)
                    .then(response => {
                    if (!response.ok) {
                    throw new Error('Network response was not ok: ' + response.statusText);
                    }
                    return response.json();
                    })
                    .then(data => {
                    console.log('Prescription data received:', data);
                    if (data.prescriptions &amp;&amp; data.prescriptions.length > 0) {
                    console.log('Found', data.prescriptions.length, 'prescriptions');
                    data.prescriptions.forEach(function(prescription) {
                    var option = document.createElement('option');
                    option.value = prescription.id;
                    var displayText = prescription.name;
                    if (prescription.date) {
                    displayText += ' (' + prescription.date + ')';
                    }
                    option.textContent = displayText;
                    prescriptionSelect.appendChild(option);
                    });
                    console.log('Added', data.prescriptions.length, 'prescription options to select');
                    } else {
                    // Add a disabled option indicating no prescriptions found
                    var option = document.createElement('option');
                    option.disabled = true;
                    option.textContent = 'Không tìm thấy đơn thuốc cho bệnh nhân này';
                    prescriptionSelect.appendChild(option);
                    console.log('No prescriptions found for this patient');
                    }
                    })
                    .catch(error => {
                    console.error('Error fetching prescriptions:', error);
                    // Show error in the select
                    var option = document.createElement('option');
                    option.disabled = true;
                    option.textContent = 'Lỗi: Không thể tải đơn thuốc';
                    prescriptionSelect.appendChild(option);
                    });
                    } else {
                    // Hide prescription selection if no patient selected
                    console.log('No patient selected, hiding prescription container');
                    prescriptionContainer.style.display = 'none';
                    }
                    });

                    // If patient is already selected on page load, trigger the change event
                    if (patientSelect.value) {
                    console.log('Patient already selected on page load, triggering change event');
                    patientSelect.dispatchEvent(new Event('change'));
                    }
                    } else {
                    console.error('Could not find one or more prescription-related elements in the DOM');
                    if (!patientSelect) console.error('Missing: patient_id select');
                    if (!prescriptionContainer) console.error('Missing: prescription-container div');
                    if (!prescriptionSelect) console.error('Missing: prescription_id select');
                    }

                    // Add prescription selection handler
                    if (prescriptionSelect) {
                    prescriptionSelect.addEventListener('change', function() {
                    var prescriptionId = this.value;

                    if (prescriptionId) {
                    // Fetch prescription details and add products to invoice
                    fetch('/api/prescription/' + prescriptionId)
                    .then(response => response.json())
                    .then(data => {
                    if (data.products &amp;&amp; data.products.length > 0) {
                    // Clear existing product lines
                    var productLines = document.querySelectorAll('.product-line');
                    productLines.forEach(function(line) {
                    line.remove();
                    });

                    // Add product lines from prescription
                    data.products.forEach(function(product) {
                    addProductLine(product.id, product.quantity, product.price);
                    });
                    }
                    })
                    .catch(error => console.error('Error fetching prescription details:', error));
                    }
                    });
                    }

                    // Add validation and submission handler
                    var submitButton = document.getElementById('submit-invoice-btn');
                    if (submitButton) {
                    submitButton.addEventListener('click', function(e) {
                    console.log('Submit button clicked');
                    try {
                    var form = document.getElementById('invoice-form');
                    if (form) {
                    if (validateInvoiceForm()) {
                    console.log('Form validated - submitting');
                    form.submit();
                    }
                    } else {
                    console.error('Form not found');
                    alert('Lỗi: Không tìm thấy form');
                    }
                    } catch (error) {
                    console.error('Error in submit handler:', error);
                    alert('Đã xảy ra lỗi: ' + error.message);
                    }
                    });
                    }

                    // Validation function
                    function validateInvoiceForm() {
                    var patientId = document.getElementById('patient_id').value;
                    if (!patientId) {
                    alert('Vui lòng chọn bệnh nhân.');
                    return false;
                    }

                    // Check if there's at least one valid service or product line
                    var hasValidLine = false;

                    document.querySelectorAll('.service-line').forEach(function(line) {
                    var serviceId = line.querySelector('select[name="service_id[]"]').value;
                    var quantity = line.querySelector('input[name="service_qty[]"]').value;
                    if (serviceId &amp;&amp; quantity > 0) {
                    hasValidLine = true;
                    }
                    });

                    document.querySelectorAll('.product-line').forEach(function(line) {
                    var productId = line.querySelector('select[name="product_id[]"]').value;
                    var quantity = line.querySelector('input[name="product_qty[]"]').value;
                    if (productId &amp;&amp; quantity > 0) {
                    hasValidLine = true;
                    }
                    });

                    if (!hasValidLine) {
                    alert('Vui lòng thêm ít nhất một dịch vụ hoặc thuốc vào hóa đơn.');
                    return false;
                    }

                    return true;
                    }

                    // Add initial lines if no existing lines (for new invoice)
                    var existingServiceLines = document.querySelectorAll('#service-lines .service-line');
                    var existingProductLines = document.querySelectorAll('#product-lines .product-line');

                    if (existingServiceLines.length === 0 &amp;&amp; existingProductLines.length === 0) {
                    // Only add one service line by default - optional
                    // addServiceLine();
                    }
                    });
                </script>
            </div>
        </t>
    </template>

    <!-- Invoice List Template -->
    <template id="invoice_list_template" name="Invoice List">
        <t t-call="invoice_management.invoice_management_layout">
            <t t-set="page_title">Danh sách hóa đơn</t>

            <!-- Filter Form -->
            <div class="im-card im-filter-form">
                <form method="GET" action="/invoice/list" class="d-flex flex-wrap w-100">
                    <div class="flex-grow-1 px-2 mb-3" style="min-width: 200px; flex-basis: 25%;">
                        <label for="state">Trạng thái</label>
                        <select name="state" id="state" class="form-control">
                            <t t-foreach="state_options" t-as="option">
                                <option t-att-value="option[0]" t-att-selected="option[0] == filter_state">
                                    <t t-esc="option[1]"/>
                                </option>
                            </t>
                        </select>
                    </div>
                    <div class="flex-grow-1 px-2 mb-3" style="min-width: 200px; flex-basis: 25%;">
                        <label for="date_from">Từ ngày</label>
                        <input type="date" name="date_from" id="date_from" class="form-control"
                               t-att-value="filter_date_from"/>
                    </div>
                    <div class="flex-grow-1 px-2 mb-3" style="min-width: 200px; flex-basis: 25%;">
                        <label for="date_to">Đến ngày</label>
                        <input type="date" name="date_to" id="date_to" class="form-control"
                               t-att-value="filter_date_to"/>
                    </div>
                    <div class="px-2 mb-3" style="min-width: 120px; flex-basis: 15%;">
                        <button type="submit" class="btn btn-primary"
                                style="margin-top: 24px; padding: 0.375rem 1.5rem;">Lọc
                        </button>
                    </div>
                </form>
            </div>

            <!-- Actions -->
            <div class="im-actions text-right">
                <a href="/invoice/create" class="btn btn-success">
                    <i class="fa fa-plus"></i>
                    Tạo hóa đơn mới
                </a>
            </div>

            <!-- Invoice Table -->
            <div class="im-card">
                <h3>Danh sách hóa đơn</h3>

                <t t-if="invoices">
                    <div class="table-responsive">
                        <table class="table table-striped im-table">
                            <thead>
                                <tr>
                                    <th>Mã hóa đơn</th>
                                    <th>Bệnh nhân</th>
                                    <th>Ngày lập</th>
                                    <th>Tổng tiền</th>
                                    <th>Bảo hiểm chi trả</th>
                                    <th>Bệnh nhân chi trả</th>
                                    <th>Trạng thái</th>
                                    <th>Thao tác</th>
                                </tr>
                            </thead>
                            <tbody>
                                <t t-foreach="invoices" t-as="invoice">
                                    <tr>
                                        <td>
                                            <t t-esc="invoice.name"/>
                                        </td>
                                        <td>
                                            <t t-esc="invoice.patient_id.name"/>
                                        </td>
                                        <td>
                                            <t t-esc="invoice.invoice_date"/>
                                        </td>
                                        <td class="im-price">
                                            <t t-esc="'{:,.0f}'.format(invoice.amount_total)"/>
                                            VND
                                        </td>
                                        <td class="im-price">
                                            <t t-esc="'{:,.0f}'.format(invoice.insurance_amount)"/>
                                            VND
                                        </td>
                                        <td class="im-price">
                                            <t t-esc="'{:,.0f}'.format(invoice.patient_amount)"/>
                                            VND
                                        </td>
                                        <td class="text-center">
                                            <t t-if="invoice.state == 'draft'">
                                                <span class="im-status-draft">Nháp</span>
                                            </t>
                                            <t t-elif="invoice.state == 'confirmed'">
                                                <span class="im-status-confirmed">Đã xác nhận</span>
                                            </t>
                                            <t t-elif="invoice.state == 'paid'">
                                                <span class="im-status-paid">Đã thanh toán</span>
                                            </t>
                                            <t t-elif="invoice.state == 'cancelled'">
                                                <span class="im-status-cancelled">Đã hủy</span>
                                            </t>
                                        </td>
                                        <td class="text-center">
                                            <a t-att-href="'/invoice/view/%s' % invoice.id" class="btn btn-sm btn-info">
                                                <i class="fa fa-eye"></i>
                                                Xem
                                            </a>
                                            <t t-if="invoice.state == 'draft'">
                                                <a t-att-href="'/invoice/edit/%s' % invoice.id"
                                                   class="btn btn-sm btn-warning ml-1">
                                                    <i class="fa fa-edit"></i>
                                                    Sửa
                                                </a>
                                            </t>
                                        </td>
                                    </tr>
                                </t>
                            </tbody>
                        </table>
                    </div>
                </t>
                <t t-else="">
                    <div class="im-empty">
                        Không tìm thấy hóa đơn nào.
                    </div>
                </t>
            </div>
        </t>
    </template>

    <!-- Invoice View Template -->
    <template id="invoice_view_template" name="Invoice View">
        <t t-call="invoice_management.invoice_management_layout">
            <t t-set="page_title">Chi tiết hóa đơn</t>

            <!-- Actions -->
            <div class="im-actions">
                <a href="/invoice/list" class="btn btn-secondary">
                    <i class="fa fa-arrow-left"></i>
                    Quay lại
                </a>

                <t t-if="invoice.state == 'draft'">
                    <a t-att-href="'/invoice/edit/%s' % invoice.id" class="btn btn-warning ml-2">
                        <i class="fa fa-edit"></i>
                        Sửa
                    </a>
                    <a t-att-href="'/invoice/action/confirm/%s' % invoice.id" class="btn btn-primary ml-2">
                        <i class="fa fa-check"></i>
                        Xác nhận
                    </a>
                    <a t-att-href="'/invoice/action/cancel/%s' % invoice.id" class="btn btn-danger ml-2"
                       onclick="return confirm('Bạn có chắc chắn muốn hủy hóa đơn này?')">
                        <i class="fa fa-times"></i>
                        Hủy
                    </a>
                </t>
                <t t-if="invoice.state == 'confirmed'">
                    <a t-att-href="'/invoice/action/pay/%s' % invoice.id" class="btn btn-success ml-2">
                        <i class="fa fa-money"></i>
                        Thanh toán
                    </a>
                    <a t-att-href="'/invoice/action/cancel/%s' % invoice.id" class="btn btn-danger ml-2"
                       onclick="return confirm('Bạn có chắc chắn muốn hủy hóa đơn này?')">
                        <i class="fa fa-times"></i>
                        Hủy
                    </a>
                </t>
                <t t-if="invoice.state == 'cancelled'">
                    <a t-att-href="'/invoice/action/reset/%s' % invoice.id" class="btn btn-warning ml-2">
                        <i class="fa fa-refresh"></i>
                        Đặt về nháp
                    </a>
                </t>
            </div>

            <!-- Invoice Information -->
            <div class="im-card">
                <h3>Thông tin hóa đơn</h3>

                <div class="row">
                    <div class="col-md-6">
                        <p>
                            <strong>Mã hóa đơn:</strong>
                            <t t-esc="invoice.name"/>
                        </p>
                        <p>
                            <strong>Ngày lập:</strong>
                            <t t-esc="invoice.invoice_date"/>
                        </p>
                        <p>
                            <strong>Trạng thái:</strong>
                            <t t-if="invoice.state == 'draft'">
                                <span class="im-status-draft">Nháp</span>
                            </t>
                            <t t-elif="invoice.state == 'confirmed'">
                                <span class="im-status-confirmed">Đã xác nhận</span>
                            </t>
                            <t t-elif="invoice.state == 'paid'">
                                <span class="im-status-paid">Đã thanh toán</span>
                            </t>
                            <t t-elif="invoice.state == 'cancelled'">
                                <span class="im-status-cancelled">Đã hủy</span>
                            </t>
                        </p>
                    </div>
                    <div class="col-md-6">
                        <p>
                            <strong>Bệnh nhân:</strong>
                            <t t-esc="invoice.patient_id.name"/>
                        </p>
                        <p>
                            <strong>Điện thoại:</strong>
                            <t t-esc="invoice.patient_id.phone or 'N/A'"/>
                        </p>
                        <p>
                            <strong>Bảo hiểm:</strong>
                            <t t-if="invoice.patient_id.has_insurance">
                                <span class="badge badge-success">Có</span>
                                <span t-esc="invoice.patient_id.insurance_number"/>
                            </t>
                            <t t-else="">
                                <span class="badge badge-secondary">Không</span>
                            </t>
                        </p>
                    </div>
                </div>
            </div>

            <!-- Service Lines -->
            <div class="im-card">
                <h3>Dịch vụ</h3>

                <t t-if="invoice.service_lines">
                    <div class="table-responsive">
                        <table class="table table-striped im-table">
                            <thead>
                                <tr>
                                    <th>Dịch vụ</th>
                                    <th class="text-center">Số lượng</th>
                                    <th class="text-right">Đơn giá</th>
                                    <th class="text-right">Thành tiền</th>
                                    <th class="text-right">Bảo hiểm chi trả</th>
                                    <th class="text-right">Bệnh nhân chi trả</th>
                                </tr>
                            </thead>
                            <tbody>
                                <t t-foreach="invoice.service_lines" t-as="line">
                                    <tr>
                                        <td>
                                            <t t-esc="line.service_id.service_name"/>
                                        </td>
                                        <td class="text-center">
                                            <t t-esc="line.quantity"/>
                                        </td>
                                        <td class="text-right">
                                            <t t-esc="'{:,.0f}'.format(line.price_unit)"/>
                                            VND
                                        </td>
                                        <td class="text-right">
                                            <t t-esc="'{:,.0f}'.format(line.price_subtotal)"/>
                                            VND
                                        </td>
                                        <td class="text-right" style="color: green;">
                                            <t t-esc="'{:,.0f}'.format(line.insurance_amount)"/>
                                            VND
                                        </td>
                                        <td class="text-right" style="color: #b91c1c;">
                                            <t t-esc="'{:,.0f}'.format(line.patient_amount)"/>
                                            VND
                                        </td>
                                    </tr>
                                </t>
                                <tr class="table-info">
                                    <td colspan="3" class="text-right">
                                        <strong>Tổng cộng:</strong>
                                    </td>
                                    <td class="text-right">
                                        <strong>
                                            <t t-esc="'{:,.0f}'.format(invoice.service_amount)"/>
                                            VND
                                        </strong>
                                    </td>
                                    <td colspan="2"></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </t>
                <t t-else="">
                    <div class="im-empty">
                        Không có dịch vụ nào.
                    </div>
                </t>
            </div>

            <!-- Product Lines -->
            <div class="im-card">
                <h3>Thuốc</h3>

                <t t-if="invoice.product_lines">
                    <div class="table-responsive">
                        <table class="table table-striped im-table">
                            <thead>
                                <tr>
                                    <th>Thuốc</th>
                                    <th class="text-center">Số lượng</th>
                                    <th class="text-right">Đơn giá</th>
                                    <th class="text-right">Thành tiền</th>
                                    <th class="text-right">Bảo hiểm chi trả</th>
                                    <th class="text-right">Bệnh nhân chi trả</th>
                                </tr>
                            </thead>
                            <tbody>
                                <t t-foreach="invoice.product_lines" t-as="line">
                                    <tr>
                                        <td>
                                            <t t-esc="line.product_id.name"/>
                                        </td>
                                        <td class="text-center">
                                            <t t-esc="line.quantity"/>
                                        </td>
                                        <td class="text-right">
                                            <t t-esc="'{:,.0f}'.format(line.price_unit)"/>
                                            VND
                                        </td>
                                        <td class="text-right">
                                            <t t-esc="'{:,.0f}'.format(line.price_subtotal)"/>
                                            VND
                                        </td>
                                        <td class="text-right" style="color: green;">
                                            <t t-esc="'{:,.0f}'.format(line.insurance_amount)"/>
                                            VND
                                        </td>
                                        <td class="text-right" style="color: #b91c1c;">
                                            <t t-esc="'{:,.0f}'.format(line.patient_amount)"/>
                                            VND
                                        </td>
                                    </tr>
                                </t>
                                <tr class="table-info">
                                    <td colspan="3" class="text-right">
                                        <strong>Tổng cộng:</strong>
                                    </td>
                                    <td class="text-right">
                                        <strong>
                                            <t t-esc="'{:,.0f}'.format(invoice.medicine_amount)"/>
                                            VND
                                        </strong>
                                    </td>
                                    <td colspan="2"></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </t>
                <t t-else="">
                    <div class="im-empty">
                        Không có thuốc nào.
                    </div>
                </t>
            </div>

            <!-- Summary -->
            <div class="im-card">
                <h3>Tổng hợp</h3>

                <div class="row">
                    <div class="col-md-6">
                        <p>
                            <strong>Ghi chú:</strong>
                            <t t-esc="invoice.note or 'Không có ghi chú'"/>
                        </p>
                    </div>
                    <div class="col-md-6">
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <tr>
                                    <th class="text-right">Tổng tiền dịch vụ:</th>
                                    <td class="text-right">
                                        <t t-esc="'{:,.0f}'.format(invoice.service_amount)"/>
                                        VND
                                    </td>
                                </tr>
                                <tr>
                                    <th class="text-right">Tổng tiền thuốc:</th>
                                    <td class="text-right">
                                        <t t-esc="'{:,.0f}'.format(invoice.medicine_amount)"/>
                                        VND
                                    </td>
                                </tr>
                                <tr>
                                    <th class="text-right">Tổng cộng:</th>
                                    <td class="text-right">
                                        <strong>
                                            <t t-esc="'{:,.0f}'.format(invoice.amount_total)"/>
                                            VND
                                        </strong>
                                    </td>
                                </tr>
                                <tr>
                                    <th class="text-right">Bảo hiểm chi trả:</th>
                                    <td class="text-right" style="color: green;">
                                        <strong>
                                            <t t-esc="'{:,.0f}'.format(invoice.insurance_amount)"/>
                                            VND
                                        </strong>
                                    </td>
                                </tr>
                                <tr>
                                    <th class="text-right">Bệnh nhân chi trả:</th>
                                    <td class="text-right" style="color: #b91c1c;">
                                        <strong>
                                            <t t-esc="'{:,.0f}'.format(invoice.patient_amount)"/>
                                            VND
                                        </strong>
                                    </td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </t>
    </template>
</odoo>